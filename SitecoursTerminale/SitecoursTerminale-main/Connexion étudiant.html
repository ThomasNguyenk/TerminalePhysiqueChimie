<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Authentification √âtudiant</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* --- D√©but de la section CSS (ESTH√âTIQUE AM√âLIOR√âE) --- */
:root {
    --primary-color: #4a90e2; /* Bleu clair dynamique */
    --secondary-color: #1a4f8d; /* Bleu marine fonc√© */
    --background-color: #f0f2f5;
    --text-color: #333;
    --error-color: #d32f2f;
}

body { 
    font-family: 'Poppins', sans-serif; /* Changement de police */
    /* NOUVELLE LIGNE POUR L'IMAGE DE FOND */
    background: url('https://static.vecteezy.com/ti/vecteur-libre/p1/13387658-carte-du-monde-connexion-avec-fond-de-site-web-moderne-futuriste-radar-ou-vecteur-de-page-de-garde-pour-le-concept-de-technologie-et-de-finance-et-l-education-future-entreprise-vectoriel.jpgt') center/cover fixed, linear-gradient(135deg, #f0f2f5 0%, #e8edf3 100%); 
    /* Le d√©grad√© doux reste en "fallback" si l'image ne charge pas. */
    margin: 0; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    height: 100vh; 
    color: var(--text-color);
    transition: background-color 0.5s;
}

.box { 
    background: #ffffff; 
    padding: 40px; 
    border-radius: 20px; /* Bordures plus douces */
    width: 380px; 
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); /* Ombre plus douce */
    border: 1px solid #e0e0e0;
    transition: transform 0.3s ease-in-out;
}
.box:hover {
    transform: translateY(-5px); /* Petit effet au survol */
}

h2 {
    margin: 0 0 30px; 
    text-align: center;
    color: var(--secondary-color); 
    font-weight: 700;
}

/* Conteneur pour l'input et l'ic√¥ne */
.input-group {
    position: relative;
    margin: 15px 0;
}

input { 
    width: 100%; 
    padding: 15px; /* Plus d'espace int√©rieur */
    border-radius: 10px; /* Bordures d'input plus douces */
    border: 1px solid #ddd; 
    box-sizing: border-box;
    transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
    font-size: 1rem;
} 

/* NOUVEAU STYLE POUR L'√âL√âMENT SELECT */
.input-group select {
    width: 100%; 
    padding: 15px; 
    border-radius: 10px; 
    border: 1px solid #ddd; 
    box-sizing: border-box;
    transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
    font-size: 1rem;
    color: #999; /* Couleur du placeholder */
    /* Assure que la fl√®che du select ne chevauche pas */
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%23666' d='M10 12l-4-4h8l-4 4z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px top 50%;
    background-size: 10px;
} 

input:focus {
    border-color: var(--primary-color); 
    box-shadow: 0 0 8px rgba(74, 144, 226, 0.3); /* Ombre au focus */
    background-color: #fafffe;
    outline: none;
}

.input-group select:focus {
    border-color: var(--primary-color); 
    box-shadow: 0 0 8px rgba(74, 144, 226, 0.3);
    background-color: #fafffe;
    outline: none;
    color: var(--text-color); /* Retrouve la couleur de texte normale au focus */
}
/* FIN NOUVEAU STYLE POUR L'√âL√âMENT SELECT */


/* Style de l'ic√¥ne/du bouton pour basculer la visibilit√© */
.toggle-password {
    position: absolute;
    top: 50%;
    right: 15px;
    transform: translateY(-50%);
    cursor: pointer;
    color: #b0b0b0; /* Couleur neutre */
    font-size: 1.2rem;
    transition: color 0.2s;
}

.toggle-password:hover {
    color: var(--primary-color);
}

button { 
    width: 100%; 
    padding: 15px; 
    border-radius: 10px; 
    border: none; 
    background: linear-gradient(to right, var(--primary-color), #2f74b5); /* D√©grad√© de couleur principal */
    color: white; 
    font-weight: 600; 
    font-size: 1.1rem;
    cursor: pointer; 
    margin-top: 25px; 
    transition: transform 0.3s, box-shadow 0.3s, opacity 0.3s; 
}

button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(74, 144, 226, 0.4);
}

.toggle-link { 
    display: block; 
    text-align: center; 
    margin-top: 25px; 
    color: var(--secondary-color); 
    cursor: pointer; 
    font-size: 0.95rem;
    transition: color 0.3s;
}

.toggle-link:hover {
    color: var(--primary-color);
    text-decoration: underline;
}

.error { 
    color: var(--error-color); 
    font-weight: 600; 
    margin-top: 20px; 
    min-height: 1.2em; 
    text-align: center;
    padding: 5px 0;
}

.small { 
    font-size: 0.8rem; 
    color: #999; 
    margin-top: 15px; 
    text-align: center; 
}

/* Style pour le message 2FA pour meilleure visibilit√© */
#mfa-send-message {
    text-align: center;
    line-height: 1.5;
    margin-bottom: 20px;
    padding: 10px;
    border: 1px dashed #ddd;
    border-radius: 8px;
    background-color: #f7f9fc;
}
/* --- Fin de la section CSS (ESTH√âTIQUE AM√âLIOR√âE) --- */
</style>
</head>
<body>
    <div class="box">
        <div id="login-view">
            <h2>Connexion √âtudiant</h2>
            <form id="loginForm">
                <div class="input-group">
                    <input type="text" id="username" placeholder="Nom d'utilisateur" required />
                </div>
                
                <div class="input-group">
                    <input type="password" id="password" placeholder="Mot de passe" required />
                    <span class="toggle-password" data-target="password">üëÅÔ∏è</span>
                </div>
                            <button type="submit">Se connecter</button>
            </form>
            <span class="toggle-link" onclick="showView('register-view')">Cr√©er un compte</span>
            <div class="small">Les comptes sont stock√©s localement sur ce navigateur.</div>
        </div>

        <div id="register-view" style="display:none">
            <h2>Inscription</h2>
            <form id="registerForm">
                <div class="input-group">
                    <input type="text" id="regUsername" placeholder="Nom d'utilisateur" required />
                </div>
                
                <div class="input-group">
                    <select id="regClass" required>
                        <option value="" disabled selected>Choisir votre classe</option>
                        <option value="Premi√®re">Premi√®re Ann√©e</option>
                        <option value="Terminale">Terminale</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <input type="password" id="regPassword" placeholder="Mot de passe (min 3)" minlength="3" required />
                    <span class="toggle-password" data-target="regPassword">üëÅÔ∏è</span>
                </div>
                <button type="submit">Cr√©er mon compte</button>
            </form>
            <span class="toggle-link" onclick="showView('login-view')">D√©j√† inscrit ? Se connecter</span>
            <div class="small">Ton compte et tes donn√©es resteront sur ce navigateur (localStorage).</div>
        </div>

        <div id="mfa-view" style="display:none">
            <h2>V√©rif. (2FA)</h2>
                        <p id="mfa-send-message">Veuillez entrer le code de v√©rification √† 4 chiffres.</p> 
            <form id="mfaForm">
                <div class="input-group">
                             <input type="text" id="mfaCode" placeholder="Code (al√©atoire)" maxlength="4" required />
                </div>
                <button type="submit">V√©rifier et Se connecter</button>
            </form>
            <span class="toggle-link" onclick="showView('login-view')">Annuler et Retour √† la Connexion</span>
        </div>

        <div id="errorMsg" class="error"></div>
    </div>

<script>
    // USERS stored in localStorage under key 'USERS' as JSON array
    function loadUsers(){
        try { return JSON.parse(localStorage.getItem('USERS')||'[]'); } catch(e){ return []; }
    }
    function saveUsers(users){ localStorage.setItem('USERS', JSON.stringify(users)); }

    // UI helpers
    function showView(id){
        document.getElementById('login-view').style.display='none';
        document.getElementById('register-view').style.display='none';
        document.getElementById('mfa-view').style.display='none';
        document.getElementById(id).style.display='block';
        document.getElementById('errorMsg').textContent='';
    }
    
    // Fonction pour finaliser la connexion apr√®s le 2FA
    function finaliseLogin(user) {
        // Nettoie le code 2FA apr√®s usage
        currentMfaCode = null;
        
        // success -> store activeUser
        localStorage.setItem('activeUser', user.username);
        // Utilise la classe enregistr√©e de l'utilisateur ou 'Premi√®re' par d√©faut
        localStorage.setItem('studentClass', user.class || 'Premi√®re'); 
        // ensure per-user keys exist
        if(!localStorage.getItem(`progress_${user.username}`)) localStorage.setItem(`progress_${user.username}`, JSON.stringify({ daily:{}, weekly:{} }));
        if(!localStorage.getItem(`notes_${user.username}`)) localStorage.setItem(`notes_${user.username}`, JSON.stringify([]));
        window.location.href = 'index.html';
    }

    // Variable globale pour stocker l'utilisateur en cours de connexion
    let userPending2FA = null;
    // NOUVEAU : Variable globale pour stocker le code 2FA g√©n√©r√©
    let currentMfaCode = null;


        // NOUVEAU : Fonction pour g√©n√©rer un code al√©atoire de 4 chiffres
        function generateMfaCode() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        // MISE √Ä JOUR : Fonction pour mettre √† jour le message 2FA (g√©n√©rique et dynamique)
        function updateMfaMessage() {
            const messageElement = document.getElementById('mfa-send-message');
            if (messageElement && currentMfaCode) {
                // Affichage g√©n√©rique du code g√©n√©r√©
                messageElement.innerHTML = `Veuillez entrer le code de v√©rification : <br><strong><span style="color: #1a4f8d; font-size: 1.6em; letter-spacing: 5px;">${currentMfaCode}</span></strong>`;
            }
        }


    // Fonctionnalit√© : Basculement du Mot de Passe
    document.querySelectorAll('.toggle-password').forEach(toggle => {
        toggle.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const passwordInput = document.getElementById(targetId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                this.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });
    });

    // Register
    document.getElementById('registerForm').addEventListener('submit', e=>{
        e.preventDefault();
        const username = document.getElementById('regUsername').value.trim();
        const password = document.getElementById('regPassword').value;
        // R√âCUP√âRATION DE LA CLASSE
        const studentClass = document.getElementById('regClass').value; 
        
        const err = document.getElementById('errorMsg');
        err.textContent='';

        if(password.length < 3){ err.textContent='Mot de passe trop court.'; return; }
        // V√âRIFICATION DE LA S√âLECTION DE CLASSE
        if(!studentClass || studentClass.startsWith('Choisir')){ err.textContent='Veuillez s√©lectionner votre classe.'; return; }
        
        const users = loadUsers();
        if(users.some(u => u.username.toLowerCase() === username.toLowerCase())){ err.textContent='Nom d‚Äôutilisateur d√©j√† pris.'; return; }

        // create user (avec la classe enregistr√©e)
        const newUser = { username, password, class: studentClass, createdAt: (new Date()).toISOString() };
        users.push(newUser);
        saveUsers(users);

        // G√©n√©ration du code et mise √† jour de la vue 2FA
        userPending2FA = newUser;
        currentMfaCode = generateMfaCode(); // G√©n√®re le nouveau code
        updateMfaMessage(); // Affiche le code g√©n√©r√©
        showView('mfa-view');
    });

    // Login
    document.getElementById('loginForm').addEventListener('submit', e=>{
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const err = document.getElementById('errorMsg');
        err.textContent='';

        const users = loadUsers();
        const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());
        if(!user){ err.textContent = "Utilisateur introuvable. Cr√©e un compte."; return; }
        if(user.password !== password){ err.textContent = "Mot de passe incorrect."; return; }
        
        // Succ√®s de la connexion, demande le 2FA
        userPending2FA = user;
        currentMfaCode = generateMfaCode(); // G√©n√®re le nouveau code
        
        // Mise √† jour du message
        updateMfaMessage();
        
        showView('mfa-view');
        document.getElementById('errorMsg').textContent = 'V√©rification 2FA requise. Entrez le code.';
    });

    // MFA (Double Authentification)
    document.getElementById('mfaForm').addEventListener('submit', e=>{
        e.preventDefault();
        const code = document.getElementById('mfaCode').value.trim();
        const err = document.getElementById('errorMsg');
        err.textContent = '';
        
        if(!userPending2FA) {
            err.textContent = "Erreur de session. Veuillez vous reconnecter.";
            showView('login-view');
            return;
        }
        
        // V√©rification contre le code g√©n√©r√© dynamiquement
        if(code === currentMfaCode){ 
            alert(`V√©rification OK ! Bienvenue, ${userPending2FA.username}.`);
            finaliseLogin(userPending2FA); // Finalise la connexion et redirige
        } else {
            err.textContent = 'Code incorrect. Veuillez r√©essayer.';
        }
    });

    // On load, create default users if none (optional)
    (function ensureDefaultUsers(){
        const u = loadUsers();
        if(u.length === 0){
            const defaults = [
                { username:'etudiant1', password:'123', class:'Premi√®re' },
                { username:'etudiant2', password:'456', class:'Terminale' } /* CHANGEMENT DE CLASSE PAR D√âFAUT */
            ];
            saveUsers(defaults);
        }
    })();
</script>
</body>
</html>